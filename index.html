<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Flood Guard</title>

<!-- Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  body {
    background-color: #f4f7f6;
  }

  #map {
    height: 500px !important;
    width: 100%;
    margin-top: 20px;
    border-radius: 15px;
    background: #eaeaea; /* helps prevent white screen */
  }

  .risk-card {
    border-left: 10px solid #28a745;
  }

  .high-risk {
    border-left: 10px solid #dc3545 !important;
    animation: blink 1s infinite;
  }

  @keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }
</style>
</head>

<body>

<div class="container py-4">

    <header class="text-center mb-4">
        <h1 class="display-5">üåä Smart Flood Guard</h1>
        <p class="lead">Location-Agnostic Flood Risk Prediction</p>
    </header>

    <div class="row justify-content-center mb-4">
        <div class="col-md-6">
            <div class="input-group shadow-sm">
                <input type="text" id="citySearch" class="form-control" placeholder="Enter city name (e.g., Mumbai, Delhi)...">
                <button class="btn btn-primary" onclick="searchCity()">üîç Search City</button>
            </div>
        </div>
    </div>

    <div class="row text-center mb-3">
        <div class="col-md-4 mb-2">
            <div class="card p-3 shadow-sm">
                <h6>Rainfall Intensity</h6>
                <h3 id="rainText">-- mm/h</h3>
            </div>
        </div>

        <div class="col-md-4 mb-2">
            <div class="card p-3 shadow-sm risk-card" id="statusCard">
                <h6>Flood Risk Status</h6>
                <h3 id="statusText">WAITING</h3>
            </div>
        </div>

        <div class="col-md-4 mb-2">
            <div class="card p-3 shadow-sm">
                <h6>Location Info</h6>
                <h3 id="cityName">--</h3>
            </div>
        </div>
    </div>

    <div id="map"></div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // 1. Initialize map
    var map = L.map('map').setView([22.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    var marker;

    // 2. SEARCH CITY FUNCTION
    async function searchCity() {
        const city = document.getElementById('citySearch').value;
        if (!city) return alert("Please enter a city name");

        try {
            // Using OpenStreetMap's free Geocoding API (Nominatim)
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`);
            const data = await response.json();

            if (data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);

                // Move map to the city
                map.setView([lat, lon], 12);
                
                // Place marker and call prediction
                updateMarkerAndPredict(lat, lon);
            } else {
                alert("City not found. Please try another name.");
            }
        } catch (error) {
            console.error("Geocoding error:", error);
        }
    }

    // 3. MAP CLICK HANDLER
    map.on('click', function(e) {
        updateMarkerAndPredict(e.latlng.lat, e.latlng.lng);
    });

    // 4. COMMON FUNCTION FOR MARKER & PREDICTION
    function updateMarkerAndPredict(lat, lon) {
        if (marker) map.removeLayer(marker);

        marker = L.marker([lat, lon]).addTo(map)
            .bindPopup(`Lat: ${lat.toFixed(3)}<br>Lng: ${lon.toFixed(3)}`)
            .openPopup();

        simulateFloodPrediction(lat, lon);
    }

    // 5. BACKEND CONNECTED FUNCTION
    async function simulateFloodPrediction(lat, lon) {
        document.getElementById("statusText").innerText = "ANALYZING...";

        try {
            const response = await fetch(`http://127.0.0.1:8000/get_risk?lat=${lat}&lon=${lon}`);
            const data = await response.json();

            document.getElementById("rainText").innerText = data.rainfall + " mm/h";
            document.getElementById("statusText").innerText = data.risk;
            document.getElementById("cityName").innerText = data.city;

            let card = document.getElementById("statusCard");
            card.classList.remove("high-risk");
            card.style.borderLeft = "10px solid " + data.color;

            if (data.risk === "HIGH") {
                card.classList.add("high-risk");
                setTimeout(() => alert(`üö® HIGH RISK: Flood potential in ${data.city}!`), 200);
            }
        } catch (error) {
            console.error("Backend Error:", error);
            document.getElementById("statusText").innerText = "SERVER ERROR";
        }
    }
</script>

</body>
</html>